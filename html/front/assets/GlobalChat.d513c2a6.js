import{Q as m}from"./QBtn.725545ea.js";import{Q as I}from"./QInput.61b433c6.js";import{Q as v}from"./QIcon.a92d8186.js";import{Q as w}from"./QPage.a46d10af.js";import{Q as C,a as S}from"./QLayout.f2fd5456.js";import{_ as V,j as F,k as i,v as g,m as f,d,n as l,p as o,l as a,q as P,F as U,u as p,av as T,y as $,s as h,aw as N,t as _,a4 as Q,a5 as j}from"./index.0f230e14.js";import{l as z}from"./index.5c50d63d.js";import{a as y}from"./axios.ab682c6b.js";import"./QSpinner.5846cff1.js";import"./use-size.38e17cf2.js";import"./dom.d9e3a984.js";import"./use-router-link.b39cd90f.js";import"./vm.bd5b438f.js";import"./render.58209ae1.js";import"./use-key-composition.0d667f1b.js";import"./uid.937d8ee7.js";import"./use-dark.1601360c.js";import"./focus-manager.7cc6c8df.js";import"./private.use-form.7baad7be.js";import"./scroll.ec30b58f.js";import"./QResizeObserver.b5bcee06.js";const B="http://93.127.167.211:8090/api",c="http://93.127.167.211:5500",D=F({name:"DefaultPage",data(){return{socket:null,messages:[],messageInput:"",username:"",dialog:!0,room:"group_chat",nightVision:!1,selectedFile:null,uploading:!1,uploadProgress:0,socketurls:null}},created(){this.initializeSocket()},mounted(){this.getimageslink(),this.fetchUserData()},methods:{async fetchUserData(){try{const e=JSON.parse(localStorage.getItem("user"));let t=null;if(e&&e.account_type===5?(localStorage.removeItem("access_token_applicant"),t=localStorage.getItem("access_token_employer")):e&&e.account_type===6&&(localStorage.removeItem("access_token_employer"),t=localStorage.getItem("access_token_applicant")),t){const n=await y.get(`${B}/shortpolling`,{headers:{Authorization:`Bearer ${t}`}});this.user=n.data,this.first_name=this.user.first_name,this.last_name=this.user.last_name,this.username=`${this.first_name} ${this.user.last_name}`,this.joinChat()}}catch(e){console.error("Failed to fetch user data:",e)}finally{this.isLoading=!1;const e=localStorage.getItem("nightvisionTem");this.nightVision=e==="true"}},getimageslink(){this.socketrls=c},initializeSocket(){this.socket=z(c),this.socket.on("recieverkoto",r=>{this.messages.push(r),this.username!=r.username&&this.playNotificationSound()}),this.socket.on("typing",()=>{});const e=JSON.parse(localStorage.getItem("user")),t=e?e.id:null,n=e&&e.account_type===5?localStorage.getItem("access_token_employer"):localStorage.getItem("access_token_applicant");this.socket.on("connect",()=>{n&&t&&(this.socket.emit("sendToken",t,n),console.log("Token sent:",n))}),this.socket.on("tokenValidated",r=>{r?console.log("Token is valid. Proceeding..."):console.error("Invalid token. Cannot proceed.")})},joinChat(){this.username.trim()&&(this.socket.emit("joinRoom",this.room,this.username),this.messages.push({username:"System",text:`${this.username} has joined the chat conversation.`}),this.dialog=!1)},async sendMessage(){if(this.handleUpload(),this.socket&&this.messageInput.trim()){const e={username:this.username,text:this.messageInput.trim()};if(this.selectedFile){const t=new FormData;t.append("file",this.selectedFile);try{const n=await y.post(`${c}/upload`,t,{headers:{"Content-Type":"multipart/form-data"}});e.file=n.data.file,this.selectedFile=null}catch(n){console.error("Error uploading file:",n)}}this.socket.emit("message",{room:this.room,msg:e}),this.messageInput=""}},async handleUpload(){if(this.selectedFile){this.uploading=!0,this.uploadProgress=0;const e=new FormData;e.append("file",this.selectedFile);try{const t={headers:{"Content-Type":"multipart/form-data"},responseType:"json",onUploadProgress:r=>{const k=Math.round(r.loaded*100/r.total);this.uploadProgress=k}},n=await y.post(`${c}/upload`,e,t);console.log("File uploaded successfully:",n.data),console.log(this.uploadProgress),this.uploading=!1,this.selectedFile=null,this.uploadProgress=0}catch(t){console.error("Error uploading file:",t),this.uploading=!1,this.selectedFile=null,this.uploadProgress=0}}},notifyTyping(){this.socket&&this.messageInput&&this.socket.emit("typing",{room:this.room})},onFileChange(e){this.selectedFile=e.target.files[0]},isImage(e){return e&&(e.endsWith(".png")||e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".gif"))},playNotificationSound(){new Audio("/src/assets/ringtone.mp3").play().catch(t=>console.error("Error playing sound:",t))},toggleNightVision(){this.nightVision=!this.nightVision,localStorage.setItem("nightvisionTem",this.nightVision.toString())}}}),u=e=>(Q("data-v-0879afe0"),e=e(),j(),e),M={bordered:"",class:"message-list",style:{display:"flex","flex-direction":"column"}},q={style:{"max-width":"80vw"}},L={key:0,style:{color:"darkgrey"}},W={key:1},E=u(()=>o("br",null,null,-1)),K={key:2,style:{color:"gray","font-size":"15px","font-weight":"600"}},O=u(()=>o("br",null,null,-1)),A=u(()=>o("br",null,null,-1)),G=u(()=>o("br",null,null,-1)),J=["href"],H={key:4},R=["href"],X=["src","href"],Y=["disabled"],Z={key:0,class:"progress-indicator"},x={class:"progress"},ee={class:"file-input-wrapper"},se={ref:"container33"};function te(e,t,n,r,k,oe){return i(),g(C,{view:"hHh Lpr fFf",class:"bg-grey-2"},{default:f(()=>[d(S,{class:l({"night-version2":e.nightVision})},{default:f(()=>[d(w,{padding:"",class:l(["chat-container",{"night-vision":e.nightVision}])},{default:f(()=>[o("div",{class:l(["messages-container",{"messages-container-night":e.nightVision}]),ref:"messageContainer"},[o("div",M,[(i(!0),a(U,null,P(e.messages,(s,b)=>(i(),a("div",{style:{width:"100%",display:"flex",position:"relative"},key:b,class:l({sent2:s.username===e.username,received2:s.username!==e.username})},[s.username!==e.username?(i(),a("div",{key:0,class:l(["triangle-up-receiver",{"night-vision22":e.nightVision}])},null,2)):(i(),a("div",{key:1,class:l(["triangle-up-sender",{"night-vision23":e.nightVision}])},null,2)),o("div",{style:{width:"max-content"},class:l({sent:s.username===e.username,received:s.username!==e.username,"received-night":e.nightVision})},[o("div",q,[s.username=="System"?(i(),a("strong",L,p(s.username),1)):(i(),a("strong",W,p(s.username),1)),E,_(" "+p(s.text)+" ",1),s.file?(i(),a("span",K,[O,A,_("view")])):h("",!0),G,s.file?(i(),a("a",{key:3,href:this.socketrls+"/"+s.file,target:"_blank",download:""},[d(m,{color:"primary",onClick:e.sendMessage,label:s.file},null,8,["onClick","label"])],8,J)):h("",!0),s.file?(i(),a("br",H)):h("",!0),s.file?(i(),a("a",{key:5,href:this.socketrls+"/"+s.file,target:"_blank",download:""},[e.isImage(s.file)?(i(),a("img",{key:0,target:"_blank",src:this.socketrls+"/"+s.file,alt:"Uploaded image",style:{"max-width":"100%","margin-top":"5px",height:"300px"},href:this.socketrls+"/"+s.file},null,8,X)):h("",!0)],8,R)):h("",!0)])],2)],2))),128))])],2),o("form",{onSubmit:t[1]||(t[1]=T((...s)=>e.handleUpload&&e.handleUpload(...s),["prevent"])),style:{display:"none"}},[o("input",{type:"file",ref:"fileInput",onChange:t[0]||(t[0]=(...s)=>e.onFileChange&&e.onFileChange(...s))},null,544),o("button",{type:"submit",disabled:e.uploading,class:"btn btn-primary"},p(e.uploading?"Uploading...":"Upload File"),9,Y)],32),e.uploadProgress>0?(i(),a("div",Z,[o("div",x,[o("div",{class:"progress-bar",role:"progressbar",style:$({width:`${e.uploadProgress}%`}),"aria-valuenow":"25","aria-valuemin":"0","aria-valuemax":"100"},p(e.uploadProgress)+"% ",5)])])):h("",!0),o("div",ee,[o("input",{type:"file",id:"fileInput",onChange:t[2]||(t[2]=(...s)=>e.onFileChange&&e.onFileChange(...s))},null,32)]),o("div",{class:l(["input-area",{"bg3-night":e.nightVision}])},[d(I,{modelValue:e.messageInput,"onUpdate:modelValue":t[3]||(t[3]=s=>e.messageInput=s),label:"Type your message...",filled:"",onKeyup:[N(e.sendMessage,["enter"]),e.notifyTyping],class:"message-input",style:{width:"70%","background-color":"#e2e2e2","border-radius":"5px"},required:""},null,8,["modelValue","onKeyup"]),o("label",{class:l(["label2",{"bg4-night-btn":e.nightVision}]),for:"fileInput"},[this.selectedFile?(i(),g(v,{key:0,for:"fileInput",name:"check",size:"30px"})):(i(),g(v,{key:1,for:"fileInput",name:"attachment",flat:"",size:"30px"}))],2),d(m,{flat:"",icon:"nights_stay",onClick:e.toggleNightVision,class:"q-ml-md",color:e.nightVision?"white":"primary"},null,8,["onClick","color"]),d(m,{style:{width:"20%"},icon:"send",color:"primary",onClick:e.sendMessage,class:"q-pa-md q-ml-sm"},null,8,["onClick"])],2)]),_:1},8,["class"]),o("div",se,null,512)]),_:1},8,["class"])]),_:1})}var Se=V(D,[["render",te],["__scopeId","data-v-0879afe0"]]);export{Se as default};
